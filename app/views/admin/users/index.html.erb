<%= content_for :stylesheets do %>
  <link href="/assets/gentelella/datatables.net-bs/css/dataTables.bootstrap.min.css" rel="stylesheet">
  <link href="/assets/gentelella/datatables.net-buttons-bs/css/buttons.bootstrap.min.css" rel="stylesheet">
  <link href="/assets/gentelella/datatables.net-fixedheader-bs/css/fixedHeader.bootstrap.min.css" rel="stylesheet">
  <link href="/assets/gentelella/datatables.net-responsive-bs/css/responsive.bootstrap.min.css" rel="stylesheet">
  <link href="/assets/gentelella/datatables.net-scroller-bs/css/scroller.bootstrap.min.css" rel="stylesheet">
<% end %>

<div class="x_panel">
  <div class="x_title">
    <h2>用户列表 <small><%= link_to "导出文档", admin_users_path(format: "xlsx"), id: "ExportingExcel"%></small></h2>
    <ul class="nav navbar-right panel_toolbox">
      <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a></li>
    </ul>
    <div class="clearfix"></div>
  </div>
  <div class="x_content">
      <div class="row">
          <div class="col-sm-12">
            <div class="card-box table-responsive">
              <table id="datatable" class="table table-striped table-bordered" style="width:100%">
                <thead>
                  <tr>
                    <th><input type="checkbox" name="all" class="weui-check" id="all"></th>
                    <th><%= User.human_attribute_name(:avatar) %></th>
                    <th><%= User.human_attribute_name(:name) %></th>
                    <th><%= User.human_attribute_name(:number) %></th>
                    <th><%= User.human_attribute_name(:phone) %></th>
                    <th><%= User.human_attribute_name(:levels) %></th>
                    <th><%= User.human_attribute_name(:parent_phone) %></th>
                    <th><%= User.human_attribute_name(:balance) %></th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  <% @users.each_with_index do |user, index| %>
                    <tr>
                      <td><input type="checkbox" name="checkbox_<%= user.id %>" id="checkbox_<%= user.id %>"></td>
                      <td><%= image_tag user.avatar, width: 50 -%> </td>
                      <td>
                        <a><%= user.name%></a>
                        <br />
                        <small>注册时间：<%= user.created_at -%></small>
                        <br />
                        <small>会员过期：<%= user.expired_at -%></small>
                      </td>
                      <td> <%= user.number -%> </td>
                      <td> <%= user.phone -%> </td>
                      <td class="project_progress" width="200"> <%= user.current_levels -%> </td>
                      <td>
                        <%= user.parent.name -%>
                      </td>
                      <td><%= user.balance -%> <%= link_to '明细', admin_user_points_records_path(user) %></td>
                      <td>
                        <%= link_to '修改', [:edit, :admin, user] %>
                        <%= link_to t('actions.destroy'), [:admin, user], method: :delete, data: { confirm: '确定删除吗?' } %>
                      </td>
                    </tr>
                  <% end %>

                </tbody>
              </table>

            </div>
          </div>
      </div>
  </div>
</div>
<%#= paginate @users, theme: 'bootstrap' -%>
<%= content_for :javascript do %>
  <script src="/assets/gentelella/datatables.net/js/jquery.dataTables.min.js"></script>
  <script src="/assets/gentelella/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
  <script src="/assets/gentelella/datatables.net-buttons/js/dataTables.buttons.min.js"></script>
  <script src="/assets/gentelella/datatables.net-buttons-bs/js/buttons.bootstrap.min.js"></script>
  <script src="/assets/gentelella/datatables.net-buttons/js/buttons.flash.min.js"></script>
  <script src="/assets/gentelella/datatables.net-buttons/js/buttons.html5.min.js"></script>
  <script src="/assets/gentelella/datatables.net-buttons/js/buttons.print.min.js"></script>
  <script src="/assets/gentelella/datatables.net-fixedheader/js/dataTables.fixedHeader.min.js"></script>
  <script src="/assets/gentelella/datatables.net-keytable/js/dataTables.keyTable.min.js"></script>
  <script src="/assets/gentelella/datatables.net-responsive/js/dataTables.responsive.min.js"></script>
  <script src="/assets/gentelella/datatables.net-responsive-bs/js/responsive.bootstrap.js"></script>
  <script src="/assets/gentelella/datatables.net-scroller/js/dataTables.scroller.min.js"></script>
  <script src="/assets/gentelella/jszip/dist/jszip.min.js"></script>
  <script src="/assets/gentelella/pdfmake/build/pdfmake.min.js"></script>
  <script src="/assets/gentelella/pdfmake/build/vfs_fonts.js"></script>
  <script type="text/javascript">
    $("#all").on('change', function(){
       if($(this).prop("checked")) {
         $("input[name^='checkbox_']").prop("checked", true);
       } else {
         $("input[name^='checkbox_']").prop("checked", false);
       }
       set_order_ids();
     });

     $("input[name^='checkbox_']").on('change', function() {
       set_order_ids();
     });

     function set_order_ids(){
       var ids = "";

       $.each($("input[name^='checkbox_']:checked"), function() {
         ids += $(this).attr("id").replace("checkbox_", "");
         ids += ",";
       });

       if(ids != ""){
         ids = ids.substring(0, ids.length-1);
       } else {
         ids = "";
       }
       var _url = $("#ExportingExcel").attr('href');
       $("#ExportingExcel").attr('href', changeURLArg(_url, "ids", ids))
     }

     function changeURLArg(url,params,value){
       console.log(url)
       var pattern = params + '=([^&]*)';
       var replaceText = params + '=' + value;
       if(url.match(pattern)){
         var tmp = '/('+  params + '=)([^&]*)/gi';
         tmp = url.replace(eval(tmp),replaceText);
         return tmp;
       }else{
         if(url.match('[\?]')){
           return url+'&'+replaceText;
         }else{
           return url+'?'+replaceText;
         }
       }
     }
  </script>
<% end %>

